# wf-assembly-snps: Output

## Introduction

This document describes the output produced by the pipeline.

The directories listed below will be created in the results directory after the pipeline has finished. All paths are relative to the top-level results directory.

## Pipeline overview

The pipeline is built using [Nextflow](https://www.nextflow.io/) and is used to generate core genome alignment to identify SNPs and create phylogenetic trees on FastA files.

- [Input quality control](#input-quality-control) that includes ensuring input files meet a minimimum file size
  - [Initial input file check](#initial-input-file-check) ensures input FastA files meet a minimum file size
- [Core genome alignment](#core-genome-alignment)
  - [Parsnp](#parsnp)
- [Mask recombinant positions](#mask-recombinant-positions)
- [Summaries](#summaries) of the output files generated during the pipeline process
- [Pipeline information](#pipeline-information) - Report metrics generated during the workflow execution

> [!NOTE]
> `[sample]` is a unique identifier that is parsed from input filenames and excludes everything after the first period (`.`).

> [!TIP]
> All tab-separated value (TSV) files can be converted to Excel spreadsheets (XLSX) by using the parameter `--create_excel_outputs` when running the pipeline.
>
> When using this parameter, a summary workbook is created to allow for all summary files to be added to separate worksheets within the workbook.

## Input quality control

Input files must meet a minimum file size to be processed within this pipeline. If this check passes, the input files will be used to generate core genome alignments to identify SNPs and build phylogenetic trees.

### Initial input file check

<details markdown="1">
<summary><strong>QC Steps</strong></summary>

- Input files are checked to ensure that they meet a minimum file size to be processed within this pipeline `[Default: 45k]`. This is to prevent unusually small input sets from wasting compute time processing data that will not yield usable results.

</details>

## Core genome alignment

Input files that pass the quality control check are used to generate core genome alignments.

> [!IMPORTANT]
> Outputs generated by different SNP packages (ie. Parsnp, Snippy) cannot be compared even when using the same file inputs.

### Parsnp

<details markdown="1">
<summary>Output files</summary>

- `Parsnp`
  - `Parsnp.xmfa`: The core genome alignment in XMFA format.
  - `Parsnp.ggr`: Compressed representation of the core genome alignment and can be visualized with Gingr.
  - `Parsnp.tree`: Phylogeny created from the core genome alignment.
  - `Parsnp.SNPs.fa.gz`: The core SNPs of each sequence in FastA format.
  - `Parsnp.Core_Alignment.fasta`: The core genome alignment of all samples.
  - `Parsnp.SNP-Distances.Pairs.tsv`: Pairwise SNP distances of all core SNPs.
  - `Parsnp.SNP-Distances.Matrix.tsv`: Pairwise SNP distance matrix of all core SNPs.

</details>

## Mask recombinant positions

Infer SNPs that result from recombination, which may improve the resolution of the downstream phylogeny.

### Gubbins

<details markdown="1">
<summary>Output files</summary>

- `[snp_package]/Gubbins`
  - `Gubbins.labelled_tree.tree`: Phylogeny created from masked recombinant positions.
  - `[snp_package]-Gubbins.Final.tree`: Final phylogeny using the masked core genome alignment.
  - `Gubbins.recombination_positions.gff`: Recombination predictions in GFF format.
  - `Parsnp-Gubbins.masked_recombination.fasta`: Recombination-filtered set of polymorphic sites in FastA format that are used to create the phylogeny.
  - `Parsnp-Gubbins.Masked-SNP-Distances.Matrix.tsv`: Pairwise SNP distance matrix of SNPs where recombination positions are masked.

</details>

### ClonalFrameML

<details markdown="1">
<summary>Output files</summary>

- `[snp_package]/ClonalFrameML`
  - `ClonalFrameML.labelled_tree.newick`: Phylogeny created from masked recombinant positions.
  - `[snp_package]-ClonalFrameML.Final.tree`: Final phylogeny using the masked core genome alignment.
  - `ClonalFrameML.recombination_positions.txt`: List of reconstructed recombination events.
  - `Parsnp-ClonalFrameML.masked_recombination.fasta`: Reconstructed FastA sequence from recombination events that are used to create the phylogeny.
  - `Parsnp-ClonalFrameML.Masked-SNP-Distances.Matrix.tsv`: Pairwise SNP distance matrix of SNPs where recombination positions are masked.

</details>

## Summaries

Concatenation of output metrics for all samples.

> [!NOTE]
> The Summary-Report excel file is only created when the parameter `--create_excel_outputs` is used.
>
> The Summary-Report excel file has the date and time appended to the filename using the following shorthand notation: year (yyyy), month (MM), day (dd), hour (HH), minute (mm), second (ss).

<details markdown="1">
<summary>Output files</summary>

- `Summaries/`
  - `Summary.QC_File_Checks.[tsv,xlsx]`: Summary of all QC file checks detailing if a sample passes or fails each process.
  - `Summary.[snp_package].Distance-Pairs.[tsv,xlsx]`: Core snp distances between each sample.
  - `Summary.[snp_package].Distance-Matrix.[tsv,xlsx]`: Core snp distance matrix of all samples.
  - `Summary.[snp_package].Masked-Distance-Matrix.tsv`: Masked core snp distance matrix of all samples.
  - `Summary-Report_yyyy-MM-dd_HH-mm-ss.xlsx`: Excel workbook where each TSV file in the Summaries directory is added to a separate worksheet within the workbook.

</details>

## Pipeline information

Information about the pipeline execution, output logs, error logs, and QC file checks for each sample are stored here.

> [!NOTE]
> Pipeline execution files have the date and time appended to the filename using the following shorthand notation: year (yyyy), month (MM), day (dd), hour (HH), minute (mm), second (ss).

<details markdown="1">
<summary>Pipeline information</summary>

- `pipeline_info/`
  - `software_versions.yml`: Summary of the software packages used in each process and their version information.
  - `nextflow_log.[job_id].txt`: Execution log file produced by Nextflow.
  - `SNP_ID_[num_of_samples].o[job_id]`: Output log file produced by the job scheduler.
  - `SNP_ID_[num_of_samples].e[job_id]`: Error log file produced by the job scheduler.
  - `pipeline_dag_yyyy-MM-dd_HH-mm-ss.html`: Direct acrylic graph (DAG) image of the workflow that gives a visual representation of how each process connects to each other.
  - `execution_trace_yyyy-MM-dd_HH-mm-ss.txt`: Text-based summary report detailing the work directory hash, runtime, CPU usage, memory usage, etc. for each process.
  - `execution_report_yyyy-MM-dd_HH-mm-ss.html`: Summary report of all processes, including processes that passed/failed, resource usage, etc.
  - `execution_timeline_yyyy-MM-dd_HH-mm-ss.html`: Summary report detailing the runtime and memory usage of each process.
  -

</details>

<details markdown="1">
<summary>Process log information</summary>

- `pipeline_info/process_logs/`
  - `[sample].[process].command.out`: Output log file for each sample in each process.
  - `[sample].[process].command.err`: Error log file for each sample in each process.

</details>

<details markdown="1">
<summary>QC file checks</summary>

- `pipeline_info/qc_file_checks/`
  - `[sample].Initial_Input_File.[tsv,xlsx]`: Details if input FastA or Genbank file meet the minimum file size criteria for the pipeline `[Default: 45k]`.

</details>
